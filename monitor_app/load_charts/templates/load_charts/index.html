<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
{% load staticfiles %}
<head>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" type="text/css" href="{% static 'load_charts/style.css' %}" />
	<title>Average Load Monitoring Web Application</title>

	<script src="{% static "js/jquery.js" %}"></script>
</head>




<body>
	<h1>Average Load Monitoring Web Application</h1>
	<svg class='chart'></svg>
	<br>
	<table id="table-head">
		<tr>
			<th class="first-column">Time</th>
			<th>Average load per minute</th>
		</tr>
	</table>
	<div id="table-container">
		<table id="log-table">
		</table>
	</div>
</body>


<script type="text/javascript">
	getValues();

	$(document).ready(function(){
		setInterval("getValues();", 5000);
	});
	function getValues() {
		var json = $.get("/load_charts/charts-get/", function (data){ drawChart(data); });

	};

	function drawChart(values) {

		d3.select(".chart").selectAll("*").remove();

		var data = JSON.parse(values);

		updateTable(data);

		var height = 300,
			width = 570,
			margin = {top: 20, right: 30, bottom: 30, left: 50};

		var barWidth = 12;

		var col = d3.scale.linear()
			.domain([0, 255])
			.range([height, 0]);

		var x = d3.scale.ordinal()
		    .domain([0, data.length])
			.range([0, width]);

		var y = d3.scale.linear()
			.domain([d3.min(data, function(d) { return d.value; })*0.95, d3.max(data, function(d) { return d.value; })*1.05])
			.range([height, 0]);

		var xAxis = d3.svg.axis()
			.scale(x)
			.orient("bottom");

		var yAxis = d3.svg.axis()
			.scale(y)
			.orient("left");

		var chart = d3.select(".chart")
		    .attr("width", width+margin.left+margin.right)
		    .attr("height", height+margin.top+margin.bottom);

		chart.append("g")
			.attr("class", "y axis")
			.attr("transform", "translate("+margin.left+",0)")
			.call(yAxis)
		   .append("text")
		    .attr("transform", "rotate(-90)")
		    .attr("y", -45)
		    .attr("dy", ".71em")
		    .style("text-anchor", "end")
		    .text("Load Average");

		chart.append("g")
			.attr("class", "x axis")
			.attr("transform", "translate("+margin.left+"," + height + ")")
			.call(xAxis);

		chart.selectAll(".bar")
		    .data(data)
		  .enter().append("rect")
		  	.attr("fill", function(d){ return "rgb("+d3.round(col(y(d.value)))+10+","+(255-d3.round(col(y(d.value))))+",0)";})
		  	.attr("class", "bar")
			.attr("x", function(d, i) { return width - i*barWidth+margin.left-14; })
		  	.attr("width", barWidth-4)
			.attr("y", function(d) { return y(d.value); })
		    .attr("height", function(d) {return height - y(d.value); });

		chart.selectAll(".label")
			.data(data)
		  .enter().append("text")
		  	.attr("y", function(d) { return y(d.value); })
			.attr("x", function(d,i) { return width-i*barWidth-barWidth/2+margin.left+3; })
			.attr("dy", "-5")
			.attr("dx", "12")
		  	.text(function(d) { return d.value; });
	};

	function updateTable(values) {
		$("#log-table .temp").remove(); 
		for (var pos in values){
			var currValue = values[pos];
			var load = currValue.value;
			if (load > 1.5){
				var trClass = " alert"
			}
			else{
				var trClass = "";
			}
			var hour = currValue.date.substr(currValue.date.length - 8);
				
			$('#log-table').append('<tr class="temp '+trClass+'"><td class="first-column">'+hour+'</td><td>'+load+'</td></tr>');
		}
	}
</script>
